# Usa una imagen base sin soporte para GPU
FROM ubuntu:22.04

# Establece la zona horaria
ENV TZ=Europe/Madrid
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Instala Python 3.9.20
RUN apt-get update && \
    apt-get install -y software-properties-common && \
    add-apt-repository ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y python3.9 python3.9-distutils python3-pip && \
    apt-get update && \
    apt-get install -y libgl1-mesa-glx

# Establece el directorio de trabajo dentro del contenedor
WORKDIR /CICProject

# Copia el contenido del directorio actual al directorio de trabajo del contenedor
COPY . /CICProject

# Crea las carpetas input y output
RUN mkdir -p /CICProject/data /CICProject/data/images /CICProject/data/Line_output /CICProject/Image_detection/weights/

# Instala las dependencias listadas en requirements.txt
RUN pip install -r ./Image_detection/requirements.txt -f https://download.pytorch.org/whl/cu117/torch_stable.html
RUN mim install mmcv-full

# AÃ±adimos los pesos:
RUN apt-get update && apt-get install -y wget unzip python3-pip && \
    pip3 install gdown && \
    gdown --id 1n9UtHgfOA6H8cxp4Y44fG7OdXbVJzMnJ -O /CICProject/Image_detection/weights/work_dirs.zip && \
    unzip /app/Image_detection/weights/work_dirs.zip -d /CICProject/Image_detection/weights/ && \
    rm /app/Image_detection/weights/work_dirs.zip && \
    gdown --id 1cIWM7lTisd1GajDR98IymDssvvLAKH1n -O /CICProject/Image_detection/weights/weights.pth

